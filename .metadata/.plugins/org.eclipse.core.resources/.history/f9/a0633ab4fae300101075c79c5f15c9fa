/*
 * system_init.c
 *
 *  Created on: Dec 28, 2025
 *      Author: sande
 */
#include "board.h"
#include "drivers.h"

void system_clock_init(void)
{
    // 1. Enable HSI
    RCC->CR |= RCC_CR_HSION;
    while(!(RCC->CR & RCC_CR_HSIRDY));

    // 2. Configure Flash latency  (84 MHz requires 2 WS)
    FLASH->ACR |= FLASH_ACR_LATENCY_2WS;

    // 3. PLL configuration
    RCC->PLLCFGR = 0;
    RCC->PLLCFGR |= (16<<0);    // PLLM = 16
    RCC->PLLCFGR |= (336<<6);   // PLLN = 336
    RCC->PLLCFGR |= (0<<16);    // PLLP = 2
    RCC->PLLCFGR |= RCC_PLLCFGR_PLLSRC_HSI; // source = HSI
    RCC->PLLCFGR |= (7<<24);    // PLLQ = 7 (USB ok)

    // 4. Enable PLL
    RCC->CR |= RCC_CR_PLLON;
    while(!(RCC->CR & RCC_CR_PLLRDY));   // WAIT

    // 5. Set APB, AHB prescaler
    RCC->CFGR |= RCC_CFGR_HPRE_DIV1;     // AHB = 84MHz
    RCC->CFGR |= RCC_CFGR_PPRE1_DIV2;    // APB1 = 42MHz
    RCC->CFGR |= RCC_CFGR_PPRE2_DIV1;    // APB2 = 84MHz

    // 6. Switch SYSCLK to PLL
    RCC->CFGR &= ~3;
    RCC->CFGR |= RCC_CFGR_SW_PLL;
    while(((RCC->CFGR>>2)&3)!=2);        // WAIT until PLL used

    // Core running @84MHz now
}

void board_init(void)
{
   // system_clock_init();
    gpio_exti_init();
    tim2_init();
    adc_dma_init();
    dwt_init();
    oled_init();
}
