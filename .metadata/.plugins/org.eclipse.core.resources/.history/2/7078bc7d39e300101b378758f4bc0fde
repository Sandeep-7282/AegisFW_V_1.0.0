/*
 * tim2.c
 *
 *  Created on: Dec 27, 2025
 *      Author: sande
 */
#include "stm32f446xx.h"
#include "FreeRTOS.h"
#include "task.h"

extern TaskHandle_t sensorTaskHandle;     // waking Sensors task

void tim2_init(uint32_t freq_hz)
{
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;

    uint32_t timer_clk = 84000000/2;      // APB1 timer clock = 42MHz x2
    uint32_t prescaler = 42000 - 1;       // 42MHz/42000=1kHz
    uint32_t arr = (1000/freq_hz) - 1;    // desired periodic rate

    TIM2->PSC = prescaler;
    TIM2->ARR = arr;
    TIM2->DIER |= TIM_DIER_UIE;
    TIM2->CR1 |= TIM_CR1_CEN;

    NVIC_SetPriority(TIM2_IRQn,5);
    NVIC_EnableIRQ(TIM2_IRQn);
}

void TIM2_IRQHandler(void)
{
    if(TIM2->SR & TIM_SR_UIF)
    {
        TIM2->SR = ~TIM_SR_UIF;

        BaseType_t hp = pdFALSE;
        vTaskNotifyGiveFromISR(sensorTaskHandle,&hp);
        portYIELD_FROM_ISR(hp);
    }
}


