/*
 * freertos_init.c
 *
 *  Created on: Dec 26, 2025
 *      Author: sande
 */
/* application/rtos/freertos_init.c */

#include "FreeRTOS.h"
#include "task.h"
#include "freertos_init.h"
#include "uart_driver.h"
#include "gpio_driver.h"
#include "tasks_common.h"
#include "task_health.h"
#include "task_oled.h"
#include "task_sensors.h"
#include "task_cli.h"
#include "task_adc.h"

extern void task_health(void *p);
extern void task_cli(void *p);

#define APP_SLOT_A_BASE        0x0800C000UL
//#define APP_SLOT_B_BASE        0x0803E000UL
#define APP_SLOT_SIZE_BYTES   (200UL * 1024UL)

#if defined(APP_SLOT_A_BASE)
    #define APP_BASE_ADDR  APP_SLOT_A_BASE
#elif defined(APP_SLOT_B_BASE)
    #define APP_BASE_ADDR  APP_SLOT_B_BASE
#endif

static void VectorTable_Remap(void)
{
    SCB->VTOR = APP_BASE_ADDR;
    __DSB(); __ISB();
}


void rtos_start(void)
{
     // Queues
        q_sensor_events = xQueueCreate(16, sizeof(event_msg_t));
        q_oled          = xQueueCreate(8,  sizeof(event_msg_t));

        // Mutex for UART
        uart_mutex = xSemaphoreCreateMutex();

       // VectorTable_Remap();
	uart_send_str("\r\n[RTOS] Creating tasks...\r\n");

	// Tasks
	    xTaskCreate(HealthMonitor_Task, "Health", 256, NULL, 4, NULL);
	    xTaskCreate(CLI_Task,           "CLI",    512, NULL, 4, NULL);
	    xTaskCreate(Sensors_Task,       "Sensor", 512, NULL, 3, NULL);
	    xTaskCreate(ADC_Task,           "ADC",    512, NULL, 3, NULL);
	    xTaskCreate(OLED_Task,          "OLED",   512, NULL, 2, NULL);

    uart_send_str("[RTOS] Scheduler starting...\r\n");

    vTaskStartScheduler();

    while(1); // should never reach
}


