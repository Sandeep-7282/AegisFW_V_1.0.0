/*
 * I2c.c
 *
 *  Created on: Dec 14, 2025
 *      Author: sande
 */
#include "I2c.h"

void i2c1_init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;
    RCC->APB1ENR |= RCC_APB1ENR_I2C1EN;

    /* PB6, PB7 AF4 */
    GPIOB->MODER &= ~((3<<12)|(3<<14));
    GPIOB->MODER |=  ((2<<12)|(2<<14));
    GPIOB->AFR[0] |= (4<<24)|(4<<28);
    GPIOB->OTYPER |= (1<<6)|(1<<7);
    GPIOB->OSPEEDR |= (3<<12)|(3<<14);

    /* Reset I2C */
    I2C1->CR1 |= I2C_CR1_SWRST;
    I2C1->CR1 &= ~I2C_CR1_SWRST;

    /* 42 MHz APB1 */
    I2C1->CR2 = 42;
    I2C1->CCR = 210;          /* ~100 kHz */
    I2C1->TRISE = 43;

    I2C1->CR1 |= I2C_CR1_PE;
}

void i2c1_write(uint8_t addr, uint8_t *data, uint16_t len)
{
    I2C1->CR1 |= I2C_CR1_START;
    while (!(I2C1->SR1 & I2C_SR1_SB));

    (void)I2C1->SR1;
    I2C1->DR = addr << 1;

    while (!(I2C1->SR1 & I2C_SR1_ADDR));
    (void)I2C1->SR1;
    (void)I2C1->SR2;

    for (uint16_t i = 0; i < len; i++)
    {
        while (!(I2C1->SR1 & I2C_SR1_TXE));
        I2C1->DR = data[i];
    }

    while (!(I2C1->SR1 & I2C_SR1_BTF));
    I2C1->CR1 |= I2C_CR1_STOP;
}


