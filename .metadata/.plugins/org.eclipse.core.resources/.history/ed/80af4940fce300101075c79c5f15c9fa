/*
 * system_init.c
 *
 *  Created on: Dec 28, 2025
 *      Author: sande
 */
#include "board.h"
#include "drivers.h"

void system_clock_init(void)
{
    /* Enable HSI */
    RCC->CR |= RCC_CR_HSION;
    while(!(RCC->CR & RCC_CR_HSIRDY));

    /* Set FLASH wait states and enable cache */
    FLASH->ACR |= FLASH_ACR_PRFTEN | FLASH_ACR_ICEN | FLASH_ACR_DCEN;
    FLASH->ACR &= ~FLASH_ACR_LATENCY;
    FLASH->ACR |= FLASH_ACR_LATENCY_2WS;   // required for 84MHz

    /* --- Reset PLL configuration safely --- */
    RCC->PLLCFGR = (16U << 0)      |   // PLLM = 16
                   (336U << 6)     |   // PLLN = 336
                   (0U  << 16)     |   // PLLP = 2
                   (7U  << 24)     |   // PLLQ = 7
                   RCC_PLLCFGR_PLLSRC_HSI;

    /* Enable PLL */
    RCC->CR |= RCC_CR_PLLON;
    while(!(RCC->CR & RCC_CR_PLLRDY));

    /* Bus prescalers */
    RCC->CFGR &= ~RCC_CFGR_HPRE;
    RCC->CFGR |= RCC_CFGR_HPRE_DIV1;       // AHB = 84MHz

    RCC->CFGR &= ~RCC_CFGR_PPRE1;
    RCC->CFGR |= RCC_CFGR_PPRE1_DIV2;      // APB1 = 42MHz

    RCC->CFGR &= ~RCC_CFGR_PPRE2;
    RCC->CFGR |= RCC_CFGR_PPRE2_DIV1;      // APB2 = 84MHz

    /* Switch system clock source to PLL */
    RCC->CFGR &= ~RCC_CFGR_SW;
    RCC->CFGR |=  RCC_CFGR_SW_PLL;

    while(((RCC->CFGR >> 2) & 3) != 2);     // Wait for PLL as system clock
}


void board_init(void)
{
   system_clock_init();
    gpio_exti_init();
    tim2_init();
    adc_dma_init();
    dwt_init();
    oled_init();
}
