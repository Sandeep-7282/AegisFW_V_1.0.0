/*
 * tim2.c
 *
 *  Created on: Dec 27, 2025
 *      Author: sande
 */
#include "stm32f446xx.h"
#include "FreeRTOS.h"
#include "task.h"
#include "timer2.h"
#include "task_sensors.h"
#include "freertos_init.h"

void tim2_init(uint32_t freq_hz)
{
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;

    uint32_t prescaler = 42000 - 1;       // 42MHz/42000=1kHz
    uint32_t arr = (1000/freq_hz) - 1;    // desired periodic rate

    TIM2->PSC = prescaler;
    TIM2->ARR = arr;
    TIM2->DIER |= TIM_DIER_UIE;
    TIM2->CR1 |= TIM_CR1_CEN;

    NVIC_SetPriority(TIM2_IRQn,5);
    NVIC_EnableIRQ(TIM2_IRQn);
    TIM2->CR1 |= TIM_CR1_CEN;           // ENABLE timer only at the end
}

void TIM2_IRQHandler(void)
{
    if(TIM2->SR & TIM_SR_UIF)
    {
        TIM2->SR = ~TIM_SR_UIF;

        sensor_event_t ev = SENSOR_TIMER_TICK;
        BaseType_t hp = pdFALSE;
        xQueueSendFromISR(q_sensors, &ev, &hp);
        portYIELD_FROM_ISR(hp);
    }
}



