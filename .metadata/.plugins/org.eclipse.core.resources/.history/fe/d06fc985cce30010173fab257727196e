/*
 * task_sensors.c
 *
 *  Created on: Dec 27, 2025
 *      Author: sande
 */
#include "task_sensors.h"
#include "uart_threadsafe.h"
#include "tasks_common.h"
#include "freertos_init.h"

static volatile uint32_t lastImpactTick = 0;

void Sensors_Task(void *p)
{

    uprintf("[SENSORS] Task started\r\n");

    sensor_event_t ev;

    while(1)
    {

        if(xQueueReceive(q_sensors, &ev, portMAX_DELAY))
        {
        	   hb_sensor = 1; // alive for health monitor
            switch(ev)
            {
                case SENSOR_PIR:
                    uprintf("[SENS] PIR SENSOR TRIGGERED\r\n");
                    break;

                case SENSOR_IMPACT:
                    uprintf("[SENS] IMPACT DETECTED\r\n");
                    break;

                case SENSOR_BUTTON:
                    uprintf("[SENS] Button Press\r\n");
                    break;
                case SENSOR_TIMER_TICK:
                    uprintf("[SENS] Timer 2 Event\r\n");
                	break;
                case SENSOR_NONE:
                	uprintf("No Sensor Triggered\n");
                	break;
            }
        }
    }
}

void Sensors_ISR_Handler(uint8_t pin)
{
	uint32_t now = xTaskGetTickCountFromISR();
	  sensor_event_t ev = (pin == 0)  ? SENSOR_PIR :
	                        (pin == 5)  ? SENSOR_IMPACT :
	                        (pin == 13) ? SENSOR_BUTTON : SENSOR_NONE;
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    if ((now - lastImpactTick) > pdMS_TO_TICKS(50))
       {
           lastImpactTick = now;
           if(ev != SENSOR_NONE)
    xQueueSendFromISR(q_sensors,&ev,&xHigherPriorityTaskWoken);
       }
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}


