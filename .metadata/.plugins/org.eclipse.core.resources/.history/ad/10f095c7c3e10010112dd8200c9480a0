/*
 * boot_metadata.h
 *
 *  Created on: Dec 24, 2025
 *      Author: sande
 */

#ifndef INC_BOOT_METADATA_H_
#define INC_BOOT_METADATA_H_

#include <stdint.h>
#include <stdbool.h>

/* EEPROM layout */
#define METADATA_SLOT0_ADDR   0x0000
#define METADATA_SLOT1_ADDR   0x0100

/* Metadata identification */
#define BOOT_METADATA_MAGIC    0xA5A55A5A
#define BOOT_METADATA_VERSION  1

/* Image slots */
#define SLOT_A  0
#define SLOT_B  1

/* Flags */
#define META_FLAG_VALID        (1U << 0)
#define META_FLAG_PENDING      (1U << 1)
#define META_FLAG_ROLLBACK     (1U << 2)

/* Metadata structure */
typedef struct
{
    uint32_t magic;          /* Must be BOOT_METADATA_MAGIC */
    uint16_t version;        /* Structure version */
    uint16_t length;         /* sizeof(struct) */

    uint8_t  active_slot;    /* SLOT_A or SLOT_B */
    uint8_t  boot_attempts;  /* Incremented on failed boots */
    uint16_t fault_count;    /* Persistent fault counter */

    uint32_t image_crc;      /* CRC of active image */
    uint32_t flags;          /* META_FLAG_x */

    uint32_t checksum;       /* Simple checksum over all fields above */
} boot_metadata_t;

/* API */
int boot_metadata_load(boot_metadata_t *meta);
int boot_metadata_store(const boot_metadata_t *meta);
void boot_metadata_default(boot_metadata_t *meta);
int boot_metadata_store_safe(const boot_metadata_t *meta);
void boot_metadata_dump(const boot_metadata_t *m);
uint32_t metadata_checksum(const boot_metadata_t *m);
bool slot_is_valid(uint32_t base);

#endif /* INC_BOOT_METADATA_H_ */
