/*
 * oled_ssd1306.c
 *
 *  Created on: Dec 28, 2025
 *      Author: sande
 */
#include <fonts.h>
#include "stm32f446xx.h"
#include <string.h>

#define OLED_ADDR 0x78      // 0x3C << 1

#define OLED_SCL_PIN 8      // PB8
#define OLED_SDA_PIN 9      // PB9

static inline void SDA_HIGH() { GPIOB->BSRR = (1<<OLED_SDA_PIN); }
static inline void SDA_LOW()  { GPIOB->BSRR = (1<<(OLED_SDA_PIN+16)); }
static inline void SCL_HIGH() { GPIOB->BSRR = (1<<OLED_SCL_PIN); }
static inline void SCL_LOW()  { GPIOB->BSRR = (1<<(OLED_SCL_PIN+16)); }

static void i2c_delay(void)
{
    for(volatile int i=0;i<60;i++);     // ~5-7MHz safe delay
}

static void i2c_start(void)
{
    SDA_HIGH(); SCL_HIGH(); i2c_delay();
    SDA_LOW(); i2c_delay();
    SCL_LOW(); i2c_delay();
}

static void i2c_stop(void)
{
    SDA_LOW(); i2c_delay();
    SCL_HIGH(); i2c_delay();
    SDA_HIGH(); i2c_delay();
}

static void i2c_write(uint8_t data)
{
    for(int i=0;i<8;i++)
    {
        if(data & 0x80) SDA_HIGH();
        else SDA_LOW();

        i2c_delay();
        SCL_HIGH(); i2c_delay();
        SCL_LOW(); i2c_delay();
        data <<=1;
    }

    // ACK BIT
    SDA_HIGH();        // release
    i2c_delay();
    SCL_HIGH(); i2c_delay();
    SCL_LOW();  i2c_delay(); // ignore ACK
}

static void oled_cmd(uint8_t c)
{
    i2c_start();
    i2c_write(OLED_ADDR);
    i2c_write(0x00);
    i2c_write(c);
    i2c_stop();
}

void oled_init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;

    // PB8 PB9 as outputs (open drain simulated)
    GPIOB->MODER &= ~((3<<(OLED_SCL_PIN*2)) | (3<<(OLED_SDA_PIN*2)));
    GPIOB->MODER |=  ((1<<(OLED_SCL_PIN*2)) | (1<<(OLED_SDA_PIN*2)));
    GPIOB->OTYPER |= (1<<OLED_SCL_PIN) | (1<<OLED_SDA_PIN);
    GPIOB->PUPDR  |= (1<<(OLED_SCL_PIN*2)) | (1<<(OLED_SDA_PIN*2));   // pull-up

    // Init sequence
    oled_cmd(0xAE);
    oled_cmd(0x20); oled_cmd(0x00);
    oled_cmd(0x40);
    oled_cmd(0xA1);
    oled_cmd(0xC8);
    oled_cmd(0xA8); oled_cmd(63);
    oled_cmd(0xD3); oled_cmd(0x00);
    oled_cmd(0xDA); oled_cmd(0x12);
    oled_cmd(0x81); oled_cmd(0x7F);
    oled_cmd(0xA4);
    oled_cmd(0xA6);
    oled_cmd(0xD5); oled_cmd(0x80);
    oled_cmd(0x8D); oled_cmd(0x14);
    oled_cmd(0xAF);

    oled_clear();
}

void oled_clear(void)
{
    for(uint8_t p=0;p<8;p++)
    {
        oled_cmd(0xB0+p);
        oled_cmd(0x00);
        oled_cmd(0x10);

        i2c_start();
        i2c_write(OLED_ADDR);
        i2c_write(0x40);

        for(int i=0;i<128;i++) i2c_write(0x00);

        i2c_stop();
    }
}

void oled_goto(uint8_t x,uint8_t y)
{
    oled_cmd(0xB0+y);
    oled_cmd(0x00+(x&0x0F));
    oled_cmd(0x10+((x>>4)&0x0F));
}

void oled_char(char c)
{
    if(c < 32 || c > 126) c = '?';

    i2c_start();
    i2c_write(OLED_ADDR);
    i2c_write(0x40);

    for(int i=0;i<5;i++)
        i2c_write(Font5x7[c-32][i]);

    i2c_write(0x00);
    i2c_stop();
}

void oled_print(uint8_t x,uint8_t y,const char *s)
{
    oled_goto(x,y);
    while(*s) oled_char(*s++);
}


